<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="settlementMapper">

	<resultMap id="withdrawResultSet" type="withdraw">
		<result column="SELLER_NO" property="sellerNo" />
		<result column="WITHDRAW_DATE" property="withdrawDate" />
		<result column="WITHDRAW_MONEY" property="withdrawMoney" />
		<result column="ACCOUNT_NO" property="accountNo" />
		<result column="REP_NAME" property="repName" />
		<result column="REQ_RESULT" property="reqResult" />
		<result column="SELLER_NAME" property="sellerName" />
	</resultMap>
	
	<resultMap id="settlementResultSet" type="settlement">
		<result column="ALL_BALANCE" property="allBalance" />
		<result column="CONFIRM_SETTLEMENT" property="confirmSettlement" />
		<result column="PRE_SETTLEMENT" property="preSettlement" />
		<result column="REMIT_BALANCE" property="remitBalance" />
		<result column="ABLE_BALANCE" property="ableBalance" />
		<result column="ORDER_NO" property="orderNo" />
		<result column="SETTLE_DATE" property="settleDate" />
		<result column="PRICE" property="price" />
		<result column="KEYBOARDER_COUPON_PRICE" property="keyCouponPrice"/>
		<result column="STORE_COUPON_PRICE" property="stoCouponPrice" />
		<result column="COUPON_PRICE" property="couponPrice" />
		<result column="COMMISSION" property="commission" />
		<result column="SETTLE_DEPT" property="settleDept"/>
		<result column="PAYMENT_BILL" property="paymentBill"/>
		<result column ="SELLER_NO" property="sellerNo" />
	</resultMap>
	
	<resultMap id="settlementElectronicResultSet" type="settlement">
		<result column="SETTLE_DATE" property="settleDate" />
		<result column="TAX_AMOUNT" property="taxAmount" />
		<result column="SUPPLY_VALUE" property="supplyValue" />
	</resultMap>
	
	<insert id="insertWithdraw" parameterType="withdraw">
		INSERT INTO WITHDRAW (SELLER_NO
							, WITHDRAW_MONEY
							, ACCOUNT_NO
							, REP_NAME
							, REQ_RESULT)
		VALUES (#{sellerNo}
			  , #{withdrawMoney}
			  , #{accountNo}
			  , #{repName}
			  , 'N')
	</insert>
	
	<select id="selectWithdrawRequestList" parameterType="withdraw" resultMap="withdrawResultSet">
		SELECT SELLER_NAME
			 , TO_CHAR(WITHDRAW_DATE, 'YYYY-MM-DD HH24:mm:SS') AS "WITHDRAW_DATE"
			 , WITHDRAW_MONEY
			 , W.ACCOUNT_NO AS "ACCOUNT_NO"
			 , W.REP_NAME AS "REP_NAME"
			 , REQ_RESULT
		FROM WITHDRAW W
		JOIN SELLER S ON (W.SELLER_NO = S.SELLER_NO)
		WHERE W.SELLER_NO = #{sellerNo}
		AND WITHDRAW_DATE BETWEEN #{startDate} AND #{endDate}
		ORDER BY WITHDRAW_DATE DESC
	</select>
	
	<select id="selectKmoneySettlement" parameterType="_int" resultMap="settlementResultSet">
		select nvl(a.a, 0) AS "ALL_BALANCE"
			 , nvl(b.b, 0) AS "CONFIRM_SETTLEMENT"
			 , nvl(c.c, 0) AS "PRE_SETTLEMENT"
			 , nvl(d.d, 0) AS "REMIT_BALANCE"
    		 , (nvl(b.b, 0) - nvl(d.d, 0)) AS "ABLE_BALANCE"
		from 
		(select sum(settle_dept) a
		from settlement
		join orders using (order_no)
		where order_status != 4
		and seller_no = #{sellerNo}) a,
		
		(select sum(settle_dept) b
		from settlement
		join orders using (order_no)
		where order_status = 3
		and seller_no = #{sellerNo}) b,
		
		(select sum(settle_dept) c
		from settlement
		join orders using (order_no)
		where order_status in (1, 2)
		and seller_no = #{sellerNo}) c,
		
		(select sum(withdraw_money) d
		from withdraw
		where seller_no = #{sellerNo}
		and req_result = 'N') d
	</select>
	
	<select id="selectElectronicList" parameterType="_int" resultMap="settlementElectronicResultSet">
		SELECT SETTLE_DATE, SUM(TAX_AMOUNT) TAX_AMOUNT, SUM(SUPPLY_VALUE) SUPPLY_VALUE
		FROM(SELECT TO_CHAR(SETTLE_DATE, 'YYYY-MM') SETTLE_DATE
		     , TAX_AMOUNT
		     , SUPPLY_VALUE
		FROM SETTLEMENT
		WHERE SELLER_NO = #{selNo})
		GROUP BY SETTLE_DATE
		ORDER BY SETTLE_DATE DESC
	</select>
	
	<!-- 정산전체내역 조회 -장미  -->
	<select id="selectSettleTotalList" parameterType="settlement" resultMap="settlementResultSet">
		SELECT DISTINCT * 
		FROM (SELECT S.ORDER_NO
		                    , TO_CHAR(S.SETTLE_DATE , 'YY/MM/DD') "SETTLE_DATE"
		                    , P.PRICE "PRICE"
		                    , PAY.PAYMENT_BILL "PAYMENT_BILL"
		                    , S.COMMITION "COMMITION"                   
		                     , KEY.COUPON_PRICE "KEYBOARDER_COUPON_PRICE"
                    		, M.COUPON_PRICE "STORE_COUPON_PRICE"
		                    , S.SETTLE_DEPT "SETTLE_DEPT"
		                    , TO_CHAR(S.SETTLE_DATE, 'YYYY-MM') "MONTH"
		            FROM SETTLEMENT S
		            LEFT JOIN ORDERS O ON (S.ORDER_NO = O.ORDER_NO)
		            LEFT JOIN PRODUCT P ON (P.PRODUCT_NO = O.PRODUCT_NO)
		            LEFT JOIN PAYMENT PAY ON (S.ORDER_NO = PAY.ORDER_NO)
		            LEFT JOIN KEYBOARDER_USE K ON (S.ORDER_NO = K.ORDER_NO)
		            LEFT JOIN COUPON_KEYBOARDER KEY ON (K.COUPON_NO = KEY.COUPON_NO)
		            LEFT JOIN STORE_USE SU ON (S.ORDER_NO = SU.ORDER_NO)
		            LEFT JOIN COUPON_STORE M ON (SU.COUPON_NO = M.COUPON_NO)
		            WHERE S.SELLER_NO = #{sellerNo}
		            ORDER BY S.SETTLE_DATE DESC )
		WHERE MONTH = #{nowMonth}
		ORDER BY ORDER_NO DESC
	</select>
	
	<!-- 정산내역 기간조회 -장미  -->
	<select id="searchSettleList" parameterType="settlement" resultMap="settlementResultSet">
		SELECT DISTINCT * 
		FROM (SELECT S.ORDER_NO
		                    , TO_CHAR(S.SETTLE_DATE , 'YYYY-MM-DD') "SETTLE_DATE"
		                    , P.PRICE "PRICE"
		                    , PAY.PAYMENT_BILL "PAYMENT_BILL"
		                    , S.COMMITION "COMMITION"                   
		                     , KEY.COUPON_PRICE "KEYBOARDER_COUPON_PRICE"
                    		, M.COUPON_PRICE "STORE_COUPON_PRICE"
		                    , S.SETTLE_DEPT "SETTLE_DEPT"
			            FROM SETTLEMENT S
			            LEFT JOIN ORDERS O ON (S.ORDER_NO = O.ORDER_NO)
			            LEFT JOIN PRODUCT P ON (P.PRODUCT_NO = O.PRODUCT_NO)
			            LEFT JOIN PAYMENT PAY ON (S.ORDER_NO = PAY.ORDER_NO)
			            LEFT JOIN KEYBOARDER_USE K ON (S.ORDER_NO = K.ORDER_NO)
			            LEFT JOIN COUPON_KEYBOARDER KEY ON (K.COUPON_NO = KEY.COUPON_NO)
			            LEFT JOIN STORE_USE SU ON (S.ORDER_NO = SU.ORDER_NO)
			            LEFT JOIN COUPON_STORE M ON (SU.COUPON_NO = M.COUPON_NO)		
			            WHERE S.SELLER_NO = #{sellerNo}	
			            ORDER BY S.SETTLE_DATE DESC )
				WHERE EXTRACT (YEAR FROM SETTLE_DATE) = EXTRACT(YEAR FROM TO_DATE(#{searchDate}, 'YYYY-MM-DD'))
				AND EXTRACT (MONTH FROM SETTLE_DATE) = EXTRACT(MONTH FROM TO_DATE (#{searchDate}, 'YYYY-MM-DD'))	
		ORDER BY ORDER_NO DESC
		
	</select>
	
</mapper>






